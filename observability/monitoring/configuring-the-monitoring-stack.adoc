:_mod-docs-content-type: ASSEMBLY
[id="configuring-the-monitoring-stack"]
= Configuring the monitoring stack
include::_attributes/common-attributes.adoc[]
:context: configuring-the-monitoring-stack

toc::[]

The {product-title} installation program provides only a low number of configuration options before installation. Configuring most {product-title} framework components, including the cluster monitoring stack, happens after the installation.

This section explains what configuration is supported, shows how to configure the monitoring stack, and demonstrates several common configuration scenarios.

[IMPORTANT]
====
Not all configuration parameters for the monitoring stack are exposed.
Only the parameters and fields listed in the xref:../../observability/monitoring/config-map-reference-for-the-cluster-monitoring-operator.adoc#cluster-monitoring-operator-configuration-reference[Config map reference for the {cmo-full}] are supported for configuration.
====

== Prerequisites

* The monitoring stack imposes additional resource requirements. Consult the computing resources recommendations in xref:../../scalability_and_performance/recommended-performance-scale-practices/recommended-infrastructure-practices.adoc#scaling-cluster-monitoring-operator[Scaling the {cmo-full}] and verify that you have sufficient resources.

// Maintenance and support for monitoring
// include::modules/monitoring-maintenance-and-support.adoc[leveloffset=+1]

// .Additional resources
// xref:../../observability/monitoring/config-map-reference-for-the-cluster-monitoring-operator.adoc#cluster-monitoring-operator-configuration-reference[Config map reference for the {cmo-full}]

[id="maintenance-and-support_{context}"]
== Maintenance and support for monitoring

Not all configuration options for the monitoring stack are exposed. The only supported way of configuring {product-title} monitoring is by configuring the {cmo-first} using the options described in the xref:../../observability/monitoring/config-map-reference-for-the-cluster-monitoring-operator.adoc#cluster-monitoring-operator-configuration-reference[Config map reference for the {cmo-full}]. *Do not use other configurations, as they are unsupported.*

Configuration paradigms might change across Prometheus releases, and such cases can only be handled gracefully if all configuration possibilities are controlled. If you use configurations other than those described in the xref:../../observability/monitoring/config-map-reference-for-the-cluster-monitoring-operator.adoc#cluster-monitoring-operator-configuration-reference[Config map reference for the {cmo-full}], your changes will disappear because the {cmo-short} automatically reconciles any differences and resets any unsupported changes back to the originally defined state by default and by design.

[IMPORTANT]
====
Installing another Prometheus instance is not supported by the Red Hat Site Reliability Engineers (SRE).
====

include::modules/monitoring-support-considerations.adoc[leveloffset=+2]
include::modules/monitoring-support-policy-for-monitoring-operators.adoc[leveloffset=+2]
include::modules/monitoring-support-version-matrix-for-monitoring-components.adoc[leveloffset=+2]

// Preparing to configure the monitoring stack
[id="preparing-to-configure-the-monitoring-stack"]
== Preparing to configure the monitoring stack

You can configure the monitoring stack by creating and updating monitoring config maps. These config maps configure the {cmo-first}, which in turn configures the components of the monitoring stack.

include::modules/monitoring-creating-cluster-monitoring-configmap.adoc[leveloffset=+2]
include::modules/monitoring-creating-user-defined-workload-monitoring-configmap.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]

ifndef::openshift-dedicated,openshift-rosa[]
// Granting users permissions for core platform monitoring
include::modules/monitoring-granting-users-permissions-for-core-platform-monitoring.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#granting-user-permissions-using-the-web-console_enabling-monitoring-for-user-defined-projects[Granting user permissions by using the web console] 
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#granting-user-permissions-using-the-cli_enabling-monitoring-for-user-defined-projects[Granting user permissions by using the CLI]

endif::openshift-dedicated,openshift-rosa[]

// Configuring the monitoring stack
include::modules/monitoring-configuring-the-monitoring-stack.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* See xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]

// Configurable monitoring components
include::modules/monitoring-configurable-monitoring-components.adoc[leveloffset=+1]

// Moving monitoring components to different nodes
include::modules/monitoring-using-node-selectors-to-move-monitoring-components.adoc[leveloffset=+1]
[role="_additional-resources"]
.Additional resources

* xref:../../nodes/nodes/nodes-nodes-working.adoc#nodes-nodes-working-updating_nodes-nodes-working[Understanding how to update labels on nodes]
* xref:../../nodes/scheduling/nodes-scheduler-node-selectors.adoc#nodes-scheduler-node-selectors[Placing pods on specific nodes using node selectors]
* xref:../../nodes/scheduling/nodes-scheduler-pod-affinity.adoc[Placing pods relative to other pods using affinity and anti-affinity rules]
* xref:../../nodes/scheduling/nodes-scheduler-pod-topology-spread-constraints.adoc[Controlling pod placement by using pod topology spread constraints]
* xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#configuring_pod_topology_spread_constraintsfor_monitoring_configuring-the-monitoring-stack[Configuring pod topology spread constraints for monitoring]
* link:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector[Kubernetes documentation about node selectors]

include::modules/monitoring-moving-monitoring-components-to-different-nodes.adoc[leveloffset=+2]


[role="_additional-resources"]
.Additional resources

* See xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]

// Assigning tolerations to monitoring components
include::modules/monitoring-assigning-tolerations-to-monitoring-components.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* See xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
* See the xref:../../nodes/scheduling/nodes-scheduler-taints-tolerations.adoc#nodes-scheduler-taints-tolerations[{product-title} documentation] on taints and tolerations
* See the link:https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/[Kubernetes documentation] on taints and tolerations

// Setting the body size limit for metrics scraping
include::modules/monitoring-setting-the-body-size-limit-for-metrics-scraping.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* link:https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config[Prometheus scrape configuration documentation]

// Enabling a dedicated service monitor
include::modules/monitoring-configuring-dedicated-service-monitors.adoc[leveloffset=+1]
include::modules/monitoring-enabling-a-dedicated-service-monitor.adoc[leveloffset=+2]

// Configuring persistent storage
include::modules/monitoring-configuring-persistent-storage.adoc[leveloffset=+1]
include::modules/monitoring-configuring-a-persistent-volume-claim.adoc[leveloffset=+2]

ifndef::openshift-dedicated,openshift-rosa[]
include::modules/monitoring-resizing-a-persistent-volume.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources
* xref:../../scalability_and_performance/recommended-performance-scale-practices/recommended-infrastructure-practices.adoc#prometheus-database-storage-requirements_recommended-infrastructure-practices[Prometheus database storage requirements]
* xref:../../storage/expanding-persistent-volumes.adoc#expanding-pvc-filesystem_expanding-persistent-volumes[Expanding persistent volume claims (PVCs) with a file system]
endif::openshift-dedicated,openshift-rosa[]

include::modules/monitoring-modifying-retention-time-and-size-for-prometheus-metrics-data.adoc[leveloffset=+2]
include::modules/monitoring-modifying-the-retention-time-for-thanos-ruler-metrics-data.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#creating-cluster-monitoring-configmap_configuring-the-monitoring-stack[Creating a cluster monitoring config map]
* xref:../../scalability_and_performance/recommended-performance-scale-practices/recommended-infrastructure-practices.adoc#prometheus-database-storage-requirements_cluster-monitoring-operator[Prometheus database storage requirements]
* xref:../../scalability_and_performance/optimization/optimizing-storage.adoc#optimizing-storage[Recommended configurable storage technology]
* xref:../../storage/understanding-persistent-storage.adoc#understanding-persistent-storage[Understanding persistent storage]
* xref:../../scalability_and_performance/optimization/optimizing-storage.adoc#optimizing-storage[Optimizing storage]
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]

// Configuring remote write storage for Prometheus
include::modules/monitoring-configuring-remote-write-storage.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* xref:../../rest_api/monitoring_apis/prometheus-monitoring-coreos-com-v1.adoc#spec-remotewrite-writerelabelconfigs[`writeRelabelConfigs`]
* link:https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config[`relabel_config`] (Prometheus documentation)

// Configuring remote write authentication methods for Prometheus
include::modules/monitoring-supported-remote-write-authentication-settings.adoc[leveloffset=+2]
include::modules/monitoring-example-remote-write-queue-configuration.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources
ifndef::openshift-dedicated,openshift-rosa[]
* xref:../../rest_api/monitoring_apis/prometheus-monitoring-coreos-com-v1.adoc#spec-remotewrite-2[Prometheus REST API reference for remote write]
endif::openshift-dedicated,openshift-rosa[]
* link:https://prometheus.io/docs/operating/integrations/#remote-endpoints-and-storage[Setting up remote write compatible endpoints] (Prometheus documentation)
* link:https://prometheus.io/docs/practices/remote_write/#remote-write-tuning[Tuning remote write settings] (Prometheus documentation)
ifndef::openshift-dedicated,openshift-rosa[]
// This xref might be relevant for ROSA/OSD if this content is reused:
* xref:../../nodes/pods/nodes-pods-secrets.adoc#nodes-pods-secrets-about_nodes-pods-secrets[Understanding secrets]
endif::openshift-dedicated,openshift-rosa[]

include::modules/monitoring-table-of-remote-write-metrics.adoc[leveloffset=+2]

// Configuring labels for outgoing metrics
include::modules/monitoring-adding-cluster-id-labels-to-metrics.adoc[leveloffset=+1]
include::modules/monitoring-creating-cluster-id-labels-for-metrics.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#configuring-remote-write-storage_configuring-the-monitoring-stack[Configuring remote write storage]
* xref:../../support/gathering-cluster-data.adoc#support-get-cluster-id_gathering-cluster-data[Obtaining your cluster ID]

// Managing scrape sample limits for user-defined projects
include::modules/monitoring-limiting-scrape-samples-in-user-defined-projects.adoc[leveloffset=+1]
include::modules/monitoring-setting-scrape-sample-and-label-limits-for-user-defined-projects.adoc[leveloffset=+2]
include::modules/monitoring-creating-scrape-sample-alerts.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#creating-user-defined-workload-monitoring-configmap_configuring-the-monitoring-stack[Creating a user-defined workload monitoring config map]
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
* See xref:../../observability/monitoring/troubleshooting-monitoring-issues.html#determining-why-prometheus-is-consuming-disk-space_troubleshooting-monitoring-issues[Determining why Prometheus is consuming a lot of disk space] for steps to query which metrics have the highest number of scrape samples.

//Configuring external alertmanagers
include::modules/monitoring-configuring-external-alertmanagers.adoc[leveloffset=1]

//Attaching additional labels to your time series and alerts
include::modules/monitoring-attaching-additional-labels-to-your-time-series-and-alerts.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* See xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps.
* xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]

// Configuring topology spread constraints for monitoring components
include::modules/monitoring-configuring-pod-topology-spread-constraints-for-monitoring.adoc[leveloffset=1]

[role="_additional-resources"]
.Additional resources

* xref:../../nodes/scheduling/nodes-scheduler-pod-topology-spread-constraints.adoc#nodes-scheduler-pod-topology-spread-constraints-about[Controlling pod placement by using pod topology spread constraints]
* link:https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/[Kubernetes Pod Topology Spread Constraints documentation]

include::modules/monitoring-setting-up-pod-topology-spread-constraints-for-prometheus.adoc[leveloffset=2]
include::modules/monitoring-setting-up-pod-topology-spread-constraints-for-alertmanager.adoc[leveloffset=2]
include::modules/monitoring-setting-up-pod-topology-spread-constraints-for-thanos-ruler.adoc[leveloffset=2]

// Setting log levels for monitoring components
include::modules/monitoring-setting-log-levels-for-monitoring-components.adoc[leveloffset=+1]

// Setting query log for Prometheus
include::modules/monitoring-setting-query-log-file-for-prometheus.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources
* See xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* See xref:../../observability/monitoring/enabling-monitoring-for-user-defined-projects.adoc#enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects] for steps to enable user-defined monitoring.

// Enabling query logging for Thanos Querier
include::modules/monitoring-enabling-query-logging-for-thanos-querier.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* See xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps.

// Setting audit log levels for the Prometheus Adapter
include::modules/monitoring-setting-audit-log-levels-for-the-prometheus-adapter.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* See xref:../../observability/monitoring/configuring-the-monitoring-stack.adoc#preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps.

// Disabling the local Alertmanager
include::modules/monitoring-disabling-the-local-alertmanager.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources
* link:https://prometheus.io/docs/alerting/latest/alertmanager/[Prometheus Alertmanager documentation]
* xref:../../observability/monitoring/managing-alerts.adoc#[Managing alerts]

